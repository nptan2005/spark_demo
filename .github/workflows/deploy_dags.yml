name: Deploy DAGs to Composer

on:
    push:
        branches: ["main"]
        paths:
            - "dags/**"

permissions:
    id-token: write
    contents: read

jobs:
    deploy:
        runs-on: ubuntu-latest

        env:
            PROJECT_ID: ${{ secrets.GCP_PROJECT }}
            COMPOSER_ENV: ${{ secrets.COMPOSER_ENV }}
            COMPOSER_REGION: ${{ secrets.COMPOSER_REGION }}
            DAGS_DIR: dags

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud via OIDC
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: "projects/240388703642/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
                  service_account: "ci-deployer@my-cdp-demo-01.iam.gserviceaccount.com"

            - name: Setup gcloud CLI
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ env.PROJECT_ID }}

            - name: Get Composer DAGS bucket
              id: dag_bucket
              run: |
                  BUCKET=$(gcloud composer environments describe "${{ env.COMPOSER_ENV }}" \
                    --location "${{ env.COMPOSER_REGION }}" \
                    --format="value(config.dagGcsPrefix)")
                  echo "bucket=$BUCKET" >> $GITHUB_OUTPUT

            - name: Sync DAGs to Composer
              run: |
                  echo "Deploying DAG files..."
                  gsutil -m rsync -r "./${{ env.DAGS_DIR }}" "${{ steps.dag_bucket.outputs.bucket }}"

            - name: Trigger DAG (optional)
              if: ${{ github.ref == 'refs/heads/main' }}
              run: |
                  echo "Triggering DAG: spark_test_dag (change name if needed)"
                  gcloud composer environments run "${{ env.COMPOSER_ENV }}" \
                    --location "${{ env.COMPOSER_REGION }}" \
                    dags trigger -- spark_test_dag || true
